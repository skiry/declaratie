<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="styles.css">
		<script src="https://unpkg.com/pdf-lib@1.4.0"></script>
   		<script src="https://unpkg.com/downloadjs@1.4.7"></script>
   		<style>
   			input[type], select {
			  width: 50%;
			  padding: 12px 20px;
			  margin: 8px 0;
			  display: inline-block;
			  border: 1px solid #ccc;
			  border-radius: 4px;
			  box-sizing: border-box;
			}

			div {
			  margin-left: 20%;
			  margin-right: 20%;
			  border-radius: 5px;
			  background-color: #f2f2f2;
			  padding: 20px;
			}

			.form-inline {  
			  display: flex;
			  flex-flow: row wrap;
			  align-items: center;
			}

			.form-inline label {
			  margin: 5px 10px 5px 0;
			}

			.form-inline input {
			  vertical-align: middle;
			  margin: 5px 10px 5px 0;
			  padding: 10px;
			  background-color: #fff;
			  border: 1px solid #ddd;
			}


			input[type=button] {
			  width: 100%;
			  background-color: #4CAF50;
			  color: white;
			  padding: 14px 20px;
			  margin: 8px 0;
			  border: none;
			  border-radius: 4px;
			  cursor: pointer;
			}

			input[type=button]:hover {
			  background-color: #45a049;
			}

			@media (max-width: 900000px) {
			  .form-inline input {
			    margin: 10px 0;
			  }
			  
			  .form-inline {
			    flex-direction: column;
			    align-items: stretch;
			  }
			}
		</style>
	</head>

  <body>
  	<div style="text-align: center">
  	<h2>DECLARAȚIE PE PROPRIE RĂSPUNDERE</h2>
  	</div>
  	<div>
  	<form id="frm1" class="form-inline">
      <label for="nume">Nume</label>
      <input type="text" name="nume" placeholder="Numele de familie">
   
      <label for="prenume">Prenume</label>
      <input type="text" name="prenume" placeholder="Prenume">

      <label for="data">Data nasterii</label>
      <input type="date" name="data">

      <label for="adresa">Adresa</label>
      <input type="text" name="adresa" placeholder="Adresa unde locuiti acum">
      <p style="font-size: 15px; max-width: 50%">Se va completa adresa locuinței în care persoana locuiește în fapt, indiferent dacă este identică sau nu cu cea menționată în actul de identitate</p>

	  <input type="button" onclick="modifyPdf()" value="Descarca declaratia">
	</form>
  	</div>

    <p class="small">(Se va salva documentul sau vi se va deschide intr-o pagina si va trebui sa il salvati dvs.)</p>
  </body>
  <script>
  	const {
	  drawImage,
	  drawLinesOfText,
	  drawRectangle,
	  drawText,
	  PDFDocument,
	  PDFName,
	  PDFNumber,
	  PDFString,
	  PDFBool
	} = PDFLib

async function modifyPdf() {

	var x = document.getElementById("frm1");

	const getAcroForm = (pdfDoc) => {
	  return pdfDoc.context.lookup(pdfDoc.catalog.get(PDFName.of('AcroForm')));
	}

	const getAcroFields = (pdfDoc) => {
	  if (!pdfDoc.catalog.get(PDFName.of('AcroForm'))) return [];
	  const acroForm = pdfDoc.context.lookup(pdfDoc.catalog.get(PDFName.of('AcroForm')));

	  if (!acroForm.get(PDFName.of('Fields'))) return [];
	  const acroFields = acroForm.context.lookup(acroForm.get(PDFName.of('Fields')));

	  return acroFields.array.map(ref => acroForm.context.lookup(ref));
	};

	const findAcroFieldByName = (pdfDoc, name) => {
	  const acroFields = getAcroFields(pdfDoc);
	  return acroFields.find((acroField) => {
	    const fieldName = acroField.get(PDFName.of('T'));
	    return !!fieldName && fieldName.value === name;
	  });
	};

	const logAcroFieldNames = (pdfDoc) => {
	  const acroFields = getAcroFields(pdfDoc);
	  acroFields.forEach((acroField) => {
	    console.log(
	      'Field Name:',
	      acroField.get(PDFName.of('T')).toString(),
	      'Field Value:',
	      acroField.get(PDFName.of('V')),
	      'All',
	      acroField
	    );
	  });
	};


	const fillInField = (pdfDoc, fieldName, text) => {
	  const toFillField = findAcroFieldByName(pdfDoc, fieldName);
	  if (!toFillField) throw new Error(`Missing AcroField: ${fieldName}`);
	  toFillField.set(PDFName.of('V'), PDFString.of(text));
	};

	const fillInRadioButton = (pdfDoc, fieldName, alreadyFilledIn) => {
	  var toFillField = findAcroFieldByName(pdfDoc, fieldName);
	  const filledField = findAcroFieldByName(pdfDoc, alreadyFilledIn);
	  if (!toFillField) throw new Error(`Missing AcroField: ${fieldName}`);
	  if (!filledField) throw new Error(`Missing AcroField: ${alreadyFilledIn}`);
	  pdfFields = ['AP', 'AS', 'DA', 'F', 'FT', 'MK', 'P', 'Subtype', 'Type', 'V']
	  for(let i = 0; i < pdfFields.length; i++) {
	  	toFillField.set(PDFName.of(pdfFields[i]), filledField.get(PDFName.of(pdfFields[i])));
	  }
	};

	const main = async function () {
	  const url = './declaratie-buna.pdf'
	  const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer())

	  // Load a PDFDocument from the existing PDF bytes
	  const pdfDoc = await PDFDocument.load(existingPdfBytes)
	  const acroForm = getAcroForm(pdfDoc);
	  acroForm.set(PDFName.of('NeedAppearances'), PDFBool.True);

	  fillInRadioButton(pdfDoc, 'Check Box3', 'Check Box1');
	  fillInField(pdfDoc, 'nume', x.elements[0].value);
	  fillInField(pdfDoc, 'prenume', x.elements[1].value);
	  logAcroFieldNames(pdfDoc);

	  const pdfBytes = await pdfDoc.save();

	  // Trigger the browser to download the PDF document
	  download(pdfBytes, "pdf-lib_modification_example.pdf", "application/pdf");
	 }
	main();	
}
</script>
</html>

<!--
//TODO
-fix fillInField just with the value
-draw on the pdf, along with writing the values, for portability -if one wants to change his file-
-fix stuff with checkboxes - take care if i bifate 1 and 2, stuff...
-today's date default
-add semnatura
-support open existing file - updating the date in real time

 var mycanvas = document.getElementById("signature-pad"); //get your canvas
var image = mycanvas.toDataURL("image/png"); //Convert
document.getElementById("semnatura_hidden").src = image;
image = image.replace('data:image/png;base64,', '');
document.getElementById("semnatura_hidden").value = image;

doc.addImage(image, "PNG", 125, 170, 50, 25);

thats how they do it
--	>

