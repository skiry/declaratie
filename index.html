<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="styles.css">
		<script src="https://unpkg.com/pdf-lib@1.4.0"></script>
   		<script src="https://unpkg.com/downloadjs@1.4.7"></script>
	</head>

  <body>
    <button onclick="modifyPdf()">Modify PDF</button>
    <p class="small">(Your browser will download the resulting file)</p>
  </body>
  <script>
  	const {
	  drawImage,
	  drawLinesOfText,
	  drawRectangle,
	  drawText,
	  PDFArray,
	  PDFContentStream,
	  PDFDictionary,
	  PDFDocument,
	  PDFDocumentFactory,
	  PDFDocumentWriter,
	  PDFIndirectReference,
	  PDFName,
	  PDFNumber,
	  PDFRawStream,
	  PDFString,
	  PDFBool
	} = PDFLib

async function modifyPdf() {

const getAcroForm = (pdfDoc) => {
  return pdfDoc.context.lookup(pdfDoc.catalog.get(PDFName.of('AcroForm')));
}

const getAcroFields = (pdfDoc) => {
  if (!pdfDoc.catalog.get(PDFName.of('AcroForm'))) return [];
  const acroForm = pdfDoc.context.lookup(pdfDoc.catalog.get(PDFName.of('AcroForm')));

  if (!acroForm.get(PDFName.of('Fields'))) return [];
  const acroFields = acroForm.context.lookup(acroForm.get(PDFName.of('Fields')));

  return acroFields.array.map(ref => acroForm.context.lookup(ref));
};

const findAcroFieldByName = (pdfDoc, name) => {
  const acroFields = getAcroFields(pdfDoc);
  return acroFields.find((acroField) => {
    const fieldName = acroField.get(PDFName.of('T'));
    return !!fieldName && fieldName.value === name;
  });
};

const logAcroFieldNames = (pdfDoc) => {
  const acroFields = getAcroFields(pdfDoc);
  acroFields.forEach((acroField) => {
    console.log(
      'Field Name:',
      acroField.get('T').toString(),
      'Field Type:',
      acroField.get('FT').toString(),
      'Field Value:',
      acroField.get('V').toString()
    );
  });
};


const fillAcroTextField = (
  // pdfDoc,
  acroField,
  // fontObject,
  text,
  // fontSize = 15,
) => {
  acroField.set(PDFName.of('V'), PDFString.of(text));
  acroField.set(PDFName.of('Ff'), PDFNumber.of(
    1 << 0 // Read Only
    |
    1 << 12 // Multiline
  ));
};

const fillInField = (pdfDoc, fieldName, text, fontSize) => {
  const field = findAcroFieldByName(pdfDoc, fieldName);
  if (!field) throw new Error(`Missing AcroField: ${fieldName}`);
  // fillAcroTextField(pdfDoc, field, FontHelvetica, text, fontSize);
  fillAcroTextField(field, text);
};

// Have to manually create this.
// Field names can be found using `logAcroFieldNames(pdfDoc)`
const fieldNames = {
  nume: 'nume',
  prenume: 'prenume',
  data: 'data',
  radio1: '3',
};


const main = async function () {
  const url = './decl2.pdf'
  const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer())

  // Load a PDFDocument from the existing PDF bytes
  const pdfDoc = await PDFDocument.load(existingPdfBytes)

  //const [FontHelvetica] = pdfDoc.embedStandardFont('Helvetica');

  const acroForm = getAcroForm(pdfDoc);
  acroForm.set(PDFName.of('NeedAppearances'), PDFBool.True);

  fillInField(pdfDoc, fieldNames.nume, 'Ionut');
  fillInField(pdfDoc, fieldNames.prenume, 'Corneliu');
  fillInField(pdfDoc, fieldNames.data, '05.04.2020');
  fillInField(pdfDoc, fieldNames.radio1, 'True')




  const pdfBytes = await pdfDoc.save();

  // Trigger the browser to download the PDF document
  download(pdfBytes, "pdf-lib_modification_example.pdf", "application/pdf");
 }
    main();
}
</script>
</html>